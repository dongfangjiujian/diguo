<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>JAVA/JSP学习系列之十二(JSP生成jpeg图片用于投票) - Powered by EmpireCMS</title>
<meta name="keywords" content="" />
<meta name="description" content="JAVA/JSP学习系列之十二(JSP生成jpeg图片用于投票)" />
<link href="/skin/default/css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/skin/default/js/tabs.js"></script>
<script type="text/javascript" src="/e/data/js/ajax.js"></script>
</head>
<body class="showpage news">
<nav class="navbar navbar-default" role="navigation">
	<div class="container-fluid"> 
	<div class="navbar-header">
		<button type="button" class="navbar-toggle" data-toggle="collapse"
				data-target="#example-navbar-collapse">
			<span class="sr-only">切换导航</span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="#">香水百合</a>
	</div>
	<div class="collapse navbar-collapse" id="example-navbar-collapse">
		<ul class="nav navbar-nav">
			
			  <li id="tabnav_btn_1" onmouseover="tabit(this)"><a href="/news/">新闻中心</a></li><li id="tabnav_btn_2" onmouseover="tabit(this)"><a href="/xiangshuigushi/">香水故事</a></li><li id="tabnav_btn_3" onmouseover="tabit(this)"><a href="/xiangshuiyongfa/">香水用法</a></li><li id="tabnav_btn_4" onmouseover="tabit(this)"><a href="/xiangshuipinpai/">香水品牌</a></li><li id="tabnav_btn_5" onmouseover="tabit(this)"><a href="/xiangshuifenlei/">香水分类</a></li><li id="tabnav_btn_6" onmouseover="tabit(this)"><a href="/test/">test</a></li>			
		</ul>
	</div>
	</div>
</nav>
<table width="100%" border="0" cellspacing="10" cellpadding="0">
<tr valign="top">
<td class="main"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="position">
<tr>
<td>您当前的位置：<a href="/">首页</a>&nbsp;>&nbsp;<a href="/test/">test</a></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="box">
<tr>
<td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="title_info">
<tr>
<td><h1>JAVA/JSP学习系列之十二(JSP生成jpeg图片用于投票)</h1></td>
</tr>
<tr>
<td class="info_text">时间：2018-10-22 15:09:30&nbsp;&nbsp;来源：JSP天空网&nbsp;&nbsp;作者：未知</td>
</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td id="text">一、前言 <br><br>　　 本文原作者为Tony Wang ，该文章涉及到文件的读写和jpg图片的自动生成。利用jsp+servlet的技术，jsp调用servlet生成图片。 <br><br>二、首文件index.jsp如下：<br><br>&lt;%-- <br><br>Author: Tony Wang <br><br>E-mail: lucky_tony@163.net <br><br>Date: 2001-01-01 <br><br>如果对程序有什么疑问，可以和我联系， 另外程序如果有什么bug，麻烦指出！！ <br><br>--%&gt;<br><br>&lt;%@ page contentType=&quot;text/html;charSet=gb2312&quot;%&gt;<br>&lt;%<br>response.setHeader(&quot;Cache-Control&quot;,&quot;no-store&quot;);<br>response.setDateHeader(&quot;Expires&quot;,0);<br>%&gt;<br>&lt;%!<br>public String[] getQuestion(String s)<br>{<br>String[] strQ = new String[4];<br>String strTemp = null;<br>int i;<br>java.io.RandomAccessFile rf = null;<br>try {<br>rf = new java.io.RandomAccessFile(s,&quot;r&quot;);<br>} catch(Exception e)<br>{<br>System.out.println(e);<br>System.exit(0);<br>}<br>for(i=0;i&lt;4;i++) <br>{<br>try {<br>strTemp = rf.readLine();<br>} catch(Exception e) {<br>strTemp = &quot;None Question&quot;;<br>}<br>if(strTemp==null)strTemp = &quot;None Question&quot;;<br>strQ[i] = strTemp;<br>}<br>return strQ;<br>}<br><br>%&gt;<br><br>&lt;%<br>String s = null;<br>String[] question = new String[4];<br><br>s = request.getRealPath(&quot;question.txt&quot;);<br>question = getQuestion(s);<br>%&gt;<br><br><br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;&lt;/title&gt;<br>&lt;link href=&quot;css.css&quot; rel=&quot;StyleSheet&quot; type=&quot;text/css&quot;&gt;&lt;/link&gt;<br>&lt;/head&gt;<br><br>&lt;body&gt;<br>&lt;table width=&quot;180&quot; border=&quot;1&quot; bordercolor=&quot;#999999&quot;&gt;<br>&lt;tr&gt;<br>&lt;td align=center&gt;冰帆调查&lt;/td&gt;<br>&lt;/tr&gt;<br>&lt;form name=frm method=post action=write.jsp&gt;<br>&lt;tr&gt; <br>&lt;td&gt;<br>&lt;%<br>String ss = null;<br>for (int i=0;i&lt;4;i++)<br>{<br>ss = &quot;&lt;input type=&quot;radio&quot; name=&quot;choice&quot; value=&quot; + i+&quot;&gt;&quot;+<br><br>(char)('A'+i)+&quot;、&quot;+ question[i]+&quot;&lt;br&gt;&quot;;<br>out.println(ss);<br>}<br>%&gt;<br>&lt;/td&gt;<br>&lt;/tr&gt;<br>&lt;tr&gt;<br>&lt;td align=center&gt;&lt;input type=submit value=&quot;我 投 一 票&quot;&gt;&lt;/td&gt;<br>&lt;/tr&gt;<br>&lt;tr&gt;<br>&lt;td align=center&gt;&lt;img src=&quot;/vote/servlet/VoteImage&quot; width=150 <br><br>height=100&gt;&lt;/td&gt;<br>&lt;/tr&gt;<br>&lt;/form&gt;<br>&lt;/table&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><br>三、写文件write.jsp<br><br>&lt;%--<br>Author: Tony Wang<br>E-mail: lucky_tony@163.net<br>Date: 2001-01-01<br>如果对程序有什么疑问，可以和我联系，<br>另外程序如果有什么bug，麻烦指出！！<br>--%&gt;<br>&lt;%!<br>public int[] getNumber(String s)<br>{<br>int[] mCount = new int[4];<br>String strTemp = null;<br>int i;<br>java.io.RandomAccessFile rf = null;<br>try {<br>rf = new java.io.RandomAccessFile(s,&quot;r&quot;);<br>} catch(Exception e)<br>{<br>System.out.println(e);<br>System.exit(0);<br>}<br>for(i=0;i&lt;4;i++) <br>{<br>try {<br>strTemp = rf.readLine();<br>} catch(Exception e) {<br>strTemp = &quot;0&quot;;<br>}<br>if(strTemp==null)strTemp = &quot;0&quot;;<br>mCount[i] = new Integer(strTemp).intValue();<br>}<br>return mCount;<br>}<br><br>public void setNumber(String s,int[] x)<br>{<br>try {<br>java.io.PrintWriter pw = new java.io.PrintWriter(new java.io.<br><br>FileOutputStream(s));<br>for (int i=0;i&lt;4;i++){<br>pw.println(x[i]+&quot;&quot;);<br>}<br>pw.close();<br>} catch(Exception e) {<br>System.out.println(&quot;Write file error:&quot;+e.getMessage());<br>}<br>}<br>%&gt;<br><br><br>&lt;%<br>String tmp = null;<br>int choice = -1;<br>int[] count = new int[4];<br>tmp = request.getParameter(&quot;choice&quot;);<br>if (tmp==null){<br>} else {<br>choice = new Integer(tmp).intValue();<br>}<br>/////////////<br>String s = request.getRealPath(&quot;count.txt&quot;);<br>if(choice&gt;=0){<br>count = getNumber(s);<br>count[choice]++;<br>setNumber(s,count);<br>}<br><br>response.sendRedirect(&quot;index.jsp&quot;);<br>%&gt;<br>四、servlet原代码：VoteImage.java :<br><br>/*<br>Author: Tony Wang<br>E-mail: lucky_tony@163.net<br>Date: 2001-01-01<br>如果对程序有什么疑问，可以和我联系，<br>另外程序如果有什么bug，麻烦指出！！<br>*/<br>import java.io.*;<br>import java.util.*;<br>import com.sun.image.codec.jpeg.*;<br>import javax.servlet.*;<br>import javax.servlet.http.*;<br>import java.awt.*;<br>import java.awt.geom.*;<br>import java.awt.image.*;<br>public class VoteImage extends HttpServlet <br>{<br>private String strFile = null;<br>private Color color[]={Color.red,Color.black,Color.orange,<br><br>Color.green};<br>private int baseAng = 30;<br>public void doGet(HttpServletRequest request,HttpServletResponse<br><br>response)<br>throws ServletException,IOException <br>{<br>strFile = request.getRealPath(&quot;count.txt&quot;);<br>float[][] xy = new float[4][2];<br>xy = getNumAndPercent(strFile);<br><br>int[] ang = new int[4];<br>ang[0] = (int)(xy[0][1]*360);<br>ang[1] = (int)(xy[1][1]*360);<br>ang[2] = (int)(xy[2][1]*360);<br>ang[3] = 360-ang[0]-ang[1]-ang[2];<br><br>response.setHeader(&quot;Cache-Control&quot;,&quot;no-store&quot;);<br>response.setDateHeader(&quot;Expires&quot;,0);<br>response.setContentType(&quot;image/jpeg&quot;);<br>ServletOutputStream out=response.getOutputStream();<br>BufferedImage image=new BufferedImage(150,100,BufferedImage.<br><br>TYPE_INT_RGB);<br>Graphics2D g=(Graphics2D)image.getGraphics();<br>g.setRenderingHint(RenderingHints.KEY_ANTIALIASING,<br><br>RenderingHints.VALUE_ANTIALIAS_ON);<br>g.setColor(Color.white);<br>g.fillRect(0,0,150,100); <br>AffineTransform at = null;<br>Arc2D arc = null;<br>int fromAng = baseAng;<br><br>at = AffineTransform.getRotateInstance((-20*java.lang.Math.PI)<br><br>/180,45,37);<br>g.setTransform(at);<br><br>int r =6;<br>int dx = (int)(r*java.lang.Math.cos((baseAng+ang[0])/2.0*java.<br><br>lang.Math.PI/180));<br>int dy = (int)(r*java.lang.Math.sin((baseAng+ang[0])/2.0*java.<br><br>lang.Math.PI/180));<br>arc = new Arc2D.Double(10+dx,24-dy,80,50,fromAng,ang[0],Arc2D.PIE);<br>g.setColor(color[0]);<br>g.fill(arc);<br>fromAng+=ang[0];<br>for (int i=1;i&lt;4;i++)<br>{<br>g.setColor(color[i]);<br>arc = new Arc2D.Double(10,24,80,50,fromAng,ang[i],Arc2D.PIE);<br>g.fill(arc);<br>fromAng+=ang[i];<br>if (fromAng&gt;360)<br>{<br>fromAng-=360;<br>}<br>}<br><br>at = AffineTransform.getRotateInstance(0,arc.getCenterX(),arc.<br><br>getCenterY());<br>g.setTransform(at);<br><br>for (int i=0;i&lt;4;i++){<br>g.setColor(color[i]);<br>g.fillRect(100,15*i+20,10,10);<br>g.drawString((char)('A'+i)+&quot;&quot;,120,15*i+20+8);<br>}<br>JPEGImageEncoder encoder=JPEGCodec.createJPEGEncoder(out);<br>encoder.encode(image);<br>out.close();<br>}<br><br>public void doPost(HttpServletRequest request,HttpServletResponse<br><br>response)<br>throws ServletException,IOException <br>{<br>doGet(request,response);<br>}<br><br>public synchronized float[][] getNumAndPercent(String sFileName)<br>{<br>float xx[][] = new float[4][2];<br>int totalNum = 0 ;<br>String strTemp = null;<br>int i = 0;<br>java.io.RandomAccessFile rf = null;<br>try <br>{<br>rf = new java.io.RandomAccessFile (sFileName,&quot;r&quot;);<br>} catch(Exception e)<br>{<br>System.out.println(e);<br>System.exit(0);<br>}<br>for (i=0;i&lt;4;i++)<br>{<br>int m=0;<br>try {<br>strTemp = rf.readLine();<br>} catch (Exception e){<br>strTemp = &quot;0&quot;;<br>}<br><br>if (strTemp == null) strTemp = &quot;0&quot;;<br>m = new Integer(strTemp).intValue();<br>xx[i][0]=m;<br>totalNum += m;<br>}<br>if (totalNum==0) totalNum=1;<br>for ( i=0;i&lt;4;i++){<br>xx[i][1] = xx[i][0]/totalNum;<br>}<br>return xx;<br>}<br>}<br><br>五、在index.jsp目录下建立question.txt和count.txt文件分别用来保存投<br><br>票的问题和投票的数量，用户投票后，就修改count.txt的值。<br><br>为了对原作者表示感谢，这2个文件内容不变化，如下：<br><br>question.txt:<br><br>Yes,I think so! <br><br>No,I dont think so! <br><br>Sorry,I dont know the answer!<br><br><br><br>count.txt:<br><br>12<br><br>9<br><br>5<br><br>9 <br><br>六、目录结构：<br><br>(1)jsp文件和txt文件同一个目录<br><br>(2).java文件是servlet目录下<br><br>七、测试：<br><br>http://[server:port]/dir/index.jsp<br><br> <br><p align="center" class="pageLink"></p></td>
</tr>
</table>
<table border="0" align="center" cellpadding="0" cellspacing="8">
<tr>
<td><table border="0" align="center" cellpadding="0" cellspacing="0" class="digg">
<tr>
<td class="diggnum" id="diggnum"><strong><script type="text/javascript" src="/e/public/ViewClick/?classid=64&id=122&down=5"></script></strong></td>
</tr>
<tr>
<td class="diggit"><a href="JavaScript:makeRequest('/e/public/digg/?classid=64&id=122&dotop=1&doajax=1&ajaxarea=diggnum','EchoReturnedText','GET','');">来顶一下</a></td>
</tr>
</table></td>
<td><table border="0" align="center" cellpadding="0" cellspacing="0" class="digg">
<tr>
<td valign="middle" class="diggnum"><strong><a href="/"><img src="/skin/default/images/back.gif" alt="返回首页" width="12" height="13" border="0" align="absmiddle" /></a></strong></td>
</tr>
<tr>
<td class="diggit"><a href="/">返回首页</a></td>
</tr>
</table></td>
</tr>
</table>
          </td>
</tr>
</table>
<script>
		  function CheckPl(obj)
		  {
		  if(obj.saytext.value=="")
		  {
		  alert("您没什么话要说吗？");
		  obj.saytext.focus();
		  return false;
		  }
		  return true;
		  }
		  </script><form action="/e/pl/doaction.php" method="post" name="saypl" id="saypl" onsubmit="return CheckPl(document.saypl)">
<table width="100%" border="0" cellpadding="0" cellspacing="0" id="plpost">

<tr>
<td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="title">
<tr>
<td><strong>发表评论</strong></td>
<td align="right"><a href="/e/pl/?classid=64&amp;id=122">共有<span><script type="text/javascript" src="/e/public/ViewClick/?classid=64&id=122&down=2"></script></span>条评论</a></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="10" cellpadding="0">
<tr>
<td><table width="100%" border="0" cellpadding="0" cellspacing="2">
<tr>
<td width="56%" align="left">用户名:
<input name="username" type="text" class="inputText" id="username" value="" size="16" /></td>
<td width="44%" align="left">密码:
<input name="password" type="password" class="inputText" id="password" value="" size="16" /></td>
</tr>
<tr>
<td align="left">验证码:
<input name="key" type="text" class="inputText" size="10" />
<img src="/e/ShowKey/?v=pl" align="absmiddle" name="plKeyImg" id="plKeyImg" onclick="plKeyImg.src='/e/ShowKey/?v=pl&t='+Math.random()" title="看不清楚,点击刷新" /> </td>
<td align="left"><input name="nomember" type="checkbox" id="nomember" value="1" checked="checked" />
匿名发表</td>
</tr>
</table>
<textarea name="saytext" rows="6" id="saytext"></textarea><input name="imageField" type="image" src="/e/data/images/postpl.gif"/>
<input name="id" type="hidden" id="id" value="122" />
<input name="classid" type="hidden" id="classid" value="64" />
<input name="enews" type="hidden" id="enews" value="AddPl" />
<input name="repid" type="hidden" id="repid" value="0" />
<input type="hidden" name="ecmsfrom" value="/test/2018-10-22/122.html"></td>
</tr>
</table>
</td>
</tr>
</table></form>
</td>
<td class="sider"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="title">
<tr>
<td><strong>推荐资讯</strong></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="8" cellpadding="0" class="box">
<tr>
<td><table width=100% border=0 cellpadding=3 cellspacing=0><tr><td align=center><a href='/news/sports/2012-12-10/78.html' target=_blank><img src='http://img1.qq.com/sports/pics/8865/8865651.jpg' width='128' height='90' border=0 alt='中国男乒第16次捧起斯韦思林杯'><br><span style='line-height:15pt'>中国男乒第16次捧起斯</span></a></td><td align=center><a href='/news/sports/2012-12-10/77.html' target=_blank><img src='http://img1.qq.com/sports/pics/10300/10300435.jpg' width='128' height='90' border=0 alt='科比专为大场面而生'><br><span style='line-height:15pt'>科比专为大场面而生</span></a></td></tr><tr><td align=center><a href='/news/ent/2012-12-10/76.html' target=_blank><img src='http://img1.qq.com/ent/pics/10290/10290791.jpg' width='128' height='90' border=0 alt='“最美清洁工”原是《赤壁》宫女'><br><span style='line-height:15pt'>“最美清洁工”原是《</span></a></td><td align=center><a href='/news/ent/2012-12-10/75.html' target=_blank><img src='http://img1.qq.com/ent/pics/10290/10290789.jpg' width='128' height='90' border=0 alt='尹馨大胆亮相《男人装》 嫩肤美腿勾人魂'><br><span style='line-height:15pt'>尹馨大胆亮相《男人装</span></a></td></tr></table></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="title margin_top">
<tr>
<td><strong>相关文章</strong></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="box">
<tr>
<td><ul>
无相关信息</ul></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="title margin_top">
<tr>
<td><strong>栏目更新</strong></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="box">
<tr>
<td><ul>
              <script src='/d/js/class/class64_newnews.js'></script></ul></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="title margin_top">
<tr>
<td><strong>栏目热门</strong></td>
</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="box">
<tr>
<td><ul>
              <script src='/d/js/class/class64_hotnews.js'></script></ul></td>
</tr>
</table></td>
</tr>
</table>
<!-- 页脚 -->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td align="center" class="search">
<form action="/e/search/index.php" method="post" name="searchform" id="searchform">
<table border="0" cellspacing="6" cellpadding="0">
<tr>
<td><strong>站内搜索：</strong>
<input name="keyboard" type="text" size="32" id="keyboard" class="inputText" />
<input type="hidden" name="show" value="title" />
<input type="hidden" name="tempid" value="1" />
<select name="tbname">
<option value="news">新闻</option>
<option value="download">下载</option>
<option value="photo">图库</option>
<option value="flash">FLASH</option>
<option value="movie">电影</option>
<option value="shop">商品</option>
<option value="article">文章</option>
<option value="info">分类信息</option>
</select>
</td>
<td><input type="image" class="inputSub" src="/skin/default/images/search.gif" />
</td>
<td><a href="/search/" target="_blank">高级搜索</a></td>
</tr>
</table>
</form>
</td>
</tr>
<tr>
<td>
	<table width="100%" border="0" cellpadding="0" cellspacing="4" class="copyright">
        <tr> 
          <td align="center"><a href="/">网站首页</a> | <a href="#">关于我们</a> 
            | <a href="#">服务条款</a> | <a href="#">广告服务</a> | <a href="#">联系我们</a> 
            | <a href="#">网站地图</a> | <a href="#">免责声明</a> | <a href="/e/wap/" target="_blank">WAP</a></td>
        </tr>
        <tr> 
          <td align="center">Powered by <strong><a href="http://www.phome.net" target="_blank">EmpireCMS</a></strong> 
            <strong><font color="#FF9900">7.5</font></strong>&nbsp; &copy; 2002-2018 
            <a href="http://www.digod.com" target="_blank">EmpireSoft Inc.</a></td>
        </tr>
	</table>
</td>
</tr>
</table>
<script src="/e/public/onclick/?enews=donews&classid=64&id=122"></script></body>
</html>